<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>積分マスター - 数学Ⅱ</title>
  <link rel="stylesheet" href="style.css">
  <!-- MathJax for rendering LaTeX -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
</head>
<body>
  <div id="app">
    <div class="card">
      <div id="quiz-container">
        <h1>積分マスター - 数学Ⅱ</h1>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="question-area">
          <div id="question-text" class="question-text">
            データを読み込み中だ...
          </div>
          <div id="options-grid" class="options-grid">
            <!-- Options will be dynamic -->
          </div>
        </div>
      </div>
      <div id="result-container" style="display: none;">
        <div class="result-screen">
          <h1>修行完了だ！</h1>
          <div id="final-score" class="score">0 / 10</div>
          <p id="result-message"></p>
          <div id="sending-status" style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;"></div>
          <button id="restart-btn" class="btn-primary">もう一度挑戦する</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // 問題データ (基本・展開の不定積分、基本・偶関数奇関数の定積分)
    // answerはoptions配列の添字ではなく、正解の文字列そのものを持たせるように変更するぜ！
    const problems = [
      {
        id: 1,
        question: "\\int (x^2 + 3x + 2) dx",
        options: ["\\frac{1}{3}x^3 + \\frac{3}{2}x^2 + 2x + C", "x^3 + 3x^2 + 2x + C", "\\frac{1}{3}x^3 + 3x^2 + C", "x^2 + 3x + C"],
        answerContent: "\\frac{1}{3}x^3 + \\frac{3}{2}x^2 + 2x + C",
        explanation: "\\int (x^2 + 3x + 2) dx = \\frac{1}{3}x^3 + \\frac{3}{2}x^2 + 2x + C だぜ！"
      },
      {
        id: 2,
        question: "\\int (x-1)(x+3) dx",
        options: ["\\frac{1}{3}x^3 + x^2 - 3x + C", "x^2 + 2x - 3 + C", "\\frac{1}{3}x^3 + 2x^2 - 3x + C", "x^3 + x^2 - 3x + C"],
        answerContent: "\\frac{1}{3}x^3 + x^2 - 3x + C",
        explanation: "展開すると x^2+2x-3。積分して \\frac{1}{3}x^3 + x^2 - 3x + C だな！"
      },
      {
        id: 3,
        question: "\\int (2x+1)^2 dx",
        options: ["\\frac{4}{3}x^3 + 2x^2 + x + C", "4x^2 + 4x + 1 + C", "\\frac{4}{3}x^3 + 4x^2 + x + C", "2x^3 + 2x^2 + x + C"],
        answerContent: "\\frac{4}{3}x^3 + 2x^2 + x + C",
        explanation: "展開すると 4x^2+4x+1。積分して \\frac{4}{3}x^3 + 2x^2 + x + C だぜ！"
      },
      {
        id: 4,
        question: "\\int 3(x+2)(x-2) dx",
        options: ["x^3 - 12x + C", "3x^2 - 12 + C", "x^3 - 4x + C", "3x^3 - 12x + C"],
        answerContent: "x^3 - 12x + C",
        explanation: "3(x^2-4) = 3x^2-12。積分して x^3 - 12x + C だな！"
      },
      {
        id: 5,
        question: "\\int (3x^2 - 6x) dx",
        options: ["x^3 - 3x^2 + C", "3x^3 - 6x^2 + C", "x^3 - 6x^2 + C", "x^3 - 2x^2 + C"],
        answerContent: "x^3 - 3x^2 + C",
        explanation: "\\int (3x^2 - 6x) dx = x^3 - 3x^2 + C だぜ！"
      },
      {
        id: 6,
        question: "\\int_1^3 (2x - 1) dx",
        options: ["6", "4", "8", "2"],
        answerContent: "6",
        explanation: "[x^2 - x]_1^3 = (9-3) - (1-1) = 6 だな！"
      },
      {
        id: 7,
        question: "\\int_0^1 (3x^2 + 4x) dx",
        options: ["3", "1", "2", "4"],
        answerContent: "3",
        explanation: "[x^3 + 2x^2]_0^1 = 1 + 2 = 3 だぜ！"
      },
      {
        id: 8,
        question: "\\int_{-1}^1 (x^3 + 3x^2 + x) dx",
        options: ["2", "4", "0", "1"],
        answerContent: "2",
        explanation: "奇関数(x^3, x)は0。\\int_{-1}^1 3x^2 dx = [x^3]_{-1}^1 = 1 - (-1) = 2 だ！"
      },
      {
        id: 9,
        question: "\\int_{-2}^2 (x^2 - 1) dx",
        options: ["\\frac{4}{3}", "\\frac{2}{3}", "\\frac{8}{3}", "0"],
        answerContent: "\\frac{4}{3}",
        explanation: "2\\int_0^2 (x^2-1) dx = 2[\\frac{1}{3}x^3 - x]_0^2 = 2(\\frac{8}{3}-2) = 2(\\frac{2}{3}) = \\frac{4}{3} だぜ！"
      },
      {
        id: 10,
        question: "\\int_0^2 (x+1)^2 dx",
        options: ["\\frac{26}{3}", "\\frac{8}{3}", "9", "\\frac{20}{3}"],
        answerContent: "\\frac{26}{3}",
        explanation: "[\\frac{1}{3}(x+1)^3]_0^2 = \\frac{1}{3}(27 - 1) = \\frac{26}{3} だな！"
      }
    ];
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];
    // GASのWebアプリURL
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzz6wXPkk1clV3WfvaDlXxIczVZ1FvWp7Gw7G7Nf5arMhtoAAaLm_ar2nxzOF6kClWY/exec';
    const questionText = document.getElementById('question-text');
    const optionsGrid = document.getElementById('options-grid');
    const progressFill = document.getElementById('progress-fill');
    const quizContainer = document.getElementById('quiz-container');
    const resultContainer = document.getElementById('result-container');
    const finalScore = document.getElementById('final-score');
    const resultMessage = document.getElementById('result-message');
    const sendingStatus = document.getElementById('sending-status');
    const restartBtn = document.getElementById('restart-btn');
    function initQuiz() {
      currentQuestionIndex = 0;
      score = 0;
      userAnswers = [];
      quizContainer.style.display = 'block';
      resultContainer.style.display = 'none';
      showQuestion();
    }
    // 配列をシャッフルする関数 (Fisher-Yates)
    function shuffleArray(array) {
      const newArr = [...array];
      for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }
    function showQuestion() {
      const problem = problems[currentQuestionIndex];
      questionText.innerHTML = `問 ${currentQuestionIndex + 1}: <br> $${problem.question}$`;
      // 選択肢をランダムに並び替える
      const shuffledOptions = shuffleArray(problem.options);
      optionsGrid.innerHTML = '';
      shuffledOptions.forEach((option) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `$${option}$`;
        // カスタムデータ属性に内容を保存しておくぜ
        btn.dataset.content = option;
        btn.onclick = () => handleAnswer(option); // 選択した「内容」で判定
        optionsGrid.appendChild(btn);
      });
      // MathJaxに再レンダリングを依頼
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
      // プログレスバー更新
      const progress = ((currentQuestionIndex) / problems.length) * 100;
      progressFill.style.width = `${progress}%`;
    }
    async function handleAnswer(selectedContent) {
      const problem = problems[currentQuestionIndex];
      const isCorrect = selectedContent === problem.answerContent;
      if (isCorrect) score++;
      userAnswers.push({
        questionId: problem.id,
        selected: selectedContent,
        correct: isCorrect
      });
      // ボタンの色を変えるフィードバック
      const btns = optionsGrid.querySelectorAll('.option-btn');
      btns.forEach(btn => {
        btn.disabled = true; // 連続クリック防止
        const content = btn.dataset.content;
        // クリックしたボタンへのフィードバック
        if (content === selectedContent) {
          btn.classList.add(isCorrect ? 'correct' : 'wrong');
        }
        // 正解のボタンを常に緑にする（不正解を選んだ時も正解を教えるぜ）
        if (content === problem.answerContent) {
          btn.classList.add('correct');
        }
      });
      // 少し待ってから次の問題へ
      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < problems.length) {
          showQuestion();
        } else {
          showResult();
        }
      }, 1000);
    }
    function showResult() {
      quizContainer.style.display = 'none';
      resultContainer.style.display = 'block';
      progressFill.style.width = '100%';
      finalScore.innerText = `${score} / ${problems.length}`;
      if (score === 10) {
        resultMessage.innerText = "完璧だ！お前はもう積分マスターだってばよ！";
      } else if (score >= 7) {
        resultMessage.innerText = "いい調子だ！さらに上を目指そうぜ！";
      } else {
        resultMessage.innerText = "まだまだ修行が必要だな。諦めんなよ！";
      }
      sendToSpreadsheet();
    }
    async function sendToSpreadsheet() {
      if (!GAS_URL) {
        sendingStatus.innerText = "（スプレッドシート連携URLが未設定なので送信をスキップしたぜ）";
        return;
      }
      sendingStatus.innerText = "結果をスプレッドシートに送信中...";
      const data = {
        score: score,
        total: problems.length,
        timestamp: new Date().toISOString(),
        answers: userAnswers
      };
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        sendingStatus.innerText = "結果をスプレッドシートに保存したぜ！";
      } catch (error) {
        console.error('Error:', error);
        sendingStatus.innerText = "送信に失敗しちまった...URLを確認してくれ。";
      }
    }
    restartBtn.onclick = initQuiz;
    // 初期化
    window.onload = initQuiz;
  </script>
</body>
</html>
